name: Contribution Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-files:
    runs-on: ubuntu-latest

    steps:
      - name: Check changed files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Verify contribution rules
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

          # Define allowed paths for community contributions
          ALLOWED_PATTERN="^knowledge/contributions/"

          # Check each changed file
          VIOLATION=false
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ ! "$file" =~ $ALLOWED_PATTERN ]]; then
              echo "❌ Not allowed: $file"
              VIOLATION=true
            else
              echo "✅ Allowed: $file"
            fi
          done

          if [ "$VIOLATION" = true ]; then
            echo ""
            echo "=========================================="
            echo "❌ CONTRIBUTION BLOCKED"
            echo "=========================================="
            echo ""
            echo "Community contributions can ONLY modify files in:"
            echo "  knowledge/contributions/"
            echo ""
            echo "Your PR modifies files outside this directory."
            echo ""
            echo "If you're adding a new accent/dialect:"
            echo "  1. Create: knowledge/contributions/<accent_id>/"
            echo "  2. Add: accent.json + content.md (or PDFs)"
            echo "  3. See CONTRIBUTING.md for details"
            echo ""
            echo "If you need to modify code, open an issue first."
            echo "=========================================="
            exit 1
          fi

          echo ""
          echo "✅ All changes are in allowed directories"

  label-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Check changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            knowledge/contributions/**

      - name: Add accent-contribution label
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['accent-contribution', 'content']
            })
